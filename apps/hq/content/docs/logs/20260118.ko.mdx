---
title: "2026-01-18"
description: "apps/web Clerk 인증 및 대기자 명단 통합"
---

## Clerk 인증 통합 및 구현 패턴

**범위**: `apps/web`

### 1단계: 초기 통합

| 파일 | 변경 사항 |
| ---- | --------- |
| `package.json` | `@clerk/nextjs@^6.36.8` 추가 |
| `src/proxy.ts` | 기존 `next-intl` i18n 미들웨어와 `clerkMiddleware()` 통합 |
| `src/app/[locale]/layout.tsx` | 앱을 감싸는 `<ClerkProvider>` 래퍼 추가 |
| `src/components/layout/app-header.tsx` | `SignedIn`/`SignedOut` 조건부 렌더링으로 `SignInButton`, `SignUpButton`, `UserButton` 추가 |
| `.env.local.example` | Clerk API 키 플레이스홀더 생성 |

### 2단계: 종합 구현 및 패턴

| 파일 | 변경 사항 |
| ---- | --------- |
| `src/env.ts` | Zod 스키마로 Clerk 환경 변수 유효성 검사 추가 |
| `src/proxy.ts` | `createRouteMatcher`와 `auth.protect()`를 사용한 라우트 보호 미들웨어 강화 |
| `src/app/[locale]/profile/page.tsx` | `auth()`와 `currentUser()`를 활용한 서버 사이드 인증 보호 페이지 생성 |
| `src/app/api/user/route.ts` | 인증 가드가 적용된 보호 API 라우트 예시 생성 |
| `src/components/user-greeting.tsx` | `useUser()` 훅을 사용하는 클라이언트 컴포넌트 예시 생성 |

### 기술적 결정

1. **미들웨어 체이닝**: `clerkMiddleware()`를 외부 래퍼로 사용하고 기존 i18n 로직을 내부 핸들러로 전달. 인증을 추가하면서 로케일 쿠키 동작을 유지.

2. **Provider 배치**: `ClerkProvider`가 `RootLayoutWrapper`를 감싸서 헤더를 포함한 앱 전체에서 인증 컨텍스트 사용 가능.

3. **모달 인증 플로우**: `SignInButton`과 `SignUpButton`에 `mode="modal"` 사용으로 인증 중에도 현재 페이지 유지.

4. **환경 변수 유효성 검사**: `env.ts`의 기존 Zod 스키마를 확장하여 Clerk 대시보드를 안내하는 설명적 오류 메시지와 함께 Clerk 키 포함.

5. **미들웨어 라우트 보호**: `createRouteMatcher()`로 보호 라우트 패턴(`/*/profile(.*)`) 정의, `auth.protect()`로 인증 강제. 로케일 접두사 라우트를 허용하면서 보호 유지.

6. **서버 사이드 인증 패턴**:
   - 최소 인증 데이터(userId 확인)에는 `auth()` 사용
   - 전체 사용자 객체가 필요할 때는 `currentUser()` 사용
   - 미인증 사용자는 홈페이지로 리다이렉트

7. **API 라우트 보호**: REST 규칙에 따라 미인증 API 요청에 401 Unauthorized 반환.

8. **클라이언트 컴포넌트 패턴**: 사용자 데이터 렌더링 전 적절한 로딩 및 로그인 상태 확인과 함께 `useUser()` 훅 사용.

### 구현 패턴

#### 서버 컴포넌트 인증

```typescript
import { auth, currentUser } from "@clerk/nextjs/server";

const { userId } = await auth();
if (!userId) redirect("/");

const user = await currentUser();
```

#### API 라우트 인증

```typescript
import { auth } from "@clerk/nextjs/server";

const { userId } = await auth();
if (!userId) {
  return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
}
```

#### 클라이언트 컴포넌트 인증

```typescript
"use client";
import { useUser } from "@clerk/nextjs";

const { isLoaded, isSignedIn, user } = useUser();
```

#### 미들웨어 라우트 보호

```typescript
import { clerkMiddleware, createRouteMatcher } from "@clerk/nextjs/server";

const isProtectedRoute = createRouteMatcher(["/*/profile(.*)"]);

export default clerkMiddleware(async (auth, request) => {
  if (isProtectedRoute(request)) {
    await auth.protect();
  }
  // ... 기타 미들웨어 로직
});
```

### 검증

- TypeScript: 통과
- LSP 진단: 오류 없음
- 빌드: `.env.local`에 Clerk API 키 필요 (예상된 동작)

---

## Clerk 대기자 명단(Waitlist) 통합

**범위**: `apps/web`

### 변경 사항

| 파일 | 변경 사항 |
| ---- | --------- |
| `src/app/[locale]/layout.tsx` | `<ClerkProvider>`에 `waitlistUrl="/"` prop 추가 |
| `src/components/layout/app-header.tsx` | `SignedIn`/`SignedOut`/`SignInButton`/`SignUpButton`을 `useClerk().openWaitlist()` 모달 트리거로 교체 |
| `src/components/landing/hero-cta.tsx` | 커스텀 폼을 Clerk 네이티브 `<Waitlist />` 컴포넌트로 교체 |
| `messages/*.json` (25개 로케일 전체) | `header.joinWaitlist` 번역 키 추가, 사용하지 않는 커스텀 폼 키 제거 |

### 기술적 결정

1. **네이티브 Clerk `<Waitlist />` 컴포넌트**: 커스텀 대기자 명단 폼을 직접 구현하는 대신 `@clerk/nextjs`의 내장 `<Waitlist />` 컴포넌트 활용. 다음과 같은 이점 제공:
   - 다른 Clerk 컴포넌트와 일관된 스타일링
   - 내장된 이메일 유효성 검사 및 제출 처리
   - Clerk 대시보드와 대기자 명단 관리 통합
   - 커스텀 백엔드 불필요

2. **`openWaitlist()` 모달**: 헤더의 "Join Waitlist" 버튼이 `useClerk().openWaitlist()`를 사용해 Clerk 대기자 명단 모달 열기. 기존 SignIn/SignUp이 모달을 열던 UX 패턴과 일치.

3. **히어로 인라인 배치**: 히어로 섹션에 메인 CTA 아래 `<Waitlist />` 컴포넌트를 인라인으로 표시하여 대기자 명단 가입의 즉각적인 가시성 제공.

4. **커스텀 폼 코드 제거**: useState 기반 커스텀 폼 구현을 Clerk 네이티브 솔루션으로 대체하여 코드 복잡성과 유지보수 부담 감소.

### 구현 패턴

#### 헤더 대기자 명단 버튼

```typescript
"use client"
import { useClerk } from "@clerk/nextjs"

export function AppHeader() {
  const { openWaitlist } = useClerk()
  
  return (
    <Button onClick={() => openWaitlist()}>
      Join Waitlist
    </Button>
  )
}
```

#### 히어로 인라인 대기자 명단

```typescript
import { Waitlist } from "@clerk/nextjs"

export function HeroCTA() {
  return (
    <div>
      {/* 기본 CTA */}
      <span>or</span>
      <Waitlist />
    </div>
  )
}
```

### 검증

- TypeScript: 통과
- LSP 진단: 오류 0개
- 빌드: 통과 (3760 페이지 생성)

### 사전 요구사항

Clerk 대시보드에서 대기자 명단 모드를 활성화해야 합니다:
1. **User & Authentication** → **Restrictions** (또는 **Waitlist settings**)로 이동
2. **Waitlist** 모드 활성화
3. 필요에 따라 자동 승인 또는 수동 검토 설정

### 다음 단계

사용자는 `.env.local`에 실제 Clerk API 키를 추가해야 합니다:

```bash
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...
CLERK_SECRET_KEY=sk_test_...
```

---

## Pane 애니메이션 및 레지스트레이션 리팩터링

**범위**: `apps/web`

### 변경 사항

| 파일 | 변경 사항 |
| ---- | --------- |
| `src/lib/animations.ts` | Pane variants 통합, `closeButtonVariants` 추가, `reducedMotionTransition` 도입. |
| `src/components/pane/pane-wrapper.tsx` | 공용 variants import 적용 및 transition/ref 타입 정리. |
| `src/components/pane/pane-content-wrapper.tsx` | pane content/close button variants를 `lib/animations`에서 사용. |
| `src/components/pane/pane-collapsed-spine.tsx` | 공용 spine variants 재사용. |
| `src/components/pane/use-pane-registration.ts` | Pane ref 등록을 위한 공용 훅 추가. |
| `src/components/pane/note-pane.tsx` | 공용 등록 훅 및 reduced motion transition 상수 적용. |
| `src/components/notes-list/all-notes-list.tsx` | 공용 등록 훅 및 reduced motion transition 상수 적용. |
| `src/components/notes-list/pane-wrapper.tsx` | `Transition`/`RefObject` 기반으로 motion 타입 보강. |
| `src/components/mobile/coverflow-pane.tsx` | reduced motion transition 처리 단순화. |
| `src/lib/landing-animations.ts` | reduced motion transition 상수 재사용. |
| `src/components/landing/hero-title.tsx` | reduced motion transition 상수 재사용. |
| `src/components/client/pane-orchestrator.tsx` | AllNotesList 직접 import로 전환해 배럴 간접 참조 제거. |
| `src/components/all-notes-list.tsx` | 배럴 re-export 파일 제거. |
| `src/components/pane/pane-animations.ts` | 중복 애니메이션 정의 제거 (lib로 통합). |

### 기술적 결정

1. **단일 애니메이션 소스**: Pane 관련 variants를 `lib/animations`로 통합해 중복과 드리프트를 방지.
2. **Reduced Motion 일관성**: `reducedMotionTransition` 상수로 일관된 동작과 객체 생성 최소화.
3. **Pane ref 등록 공유**: `usePaneRegistration`으로 pane ref 생명주기 관리 표준화.
4. **Motion 타입 강화**: `Transition`/`RefObject`로 타입 안정성 강화.
5. **직접 import**: AllNotesList 배럴을 제거해 명시적 import와 번들 간접 참조를 줄임.

### 검증

- TypeScript: 미실행
- 빌드: 미실행
- 테스트: 미실행

### 다음 단계

리팩터링 검증이 필요하면 TypeScript/빌드 체크를 실행하세요.

---

## 랜딩 Import 정리 & Reduced Motion 개선

**범위**: `apps/web`

### 변경 사항

| 파일 | 변경 사항 |
| ---- | --------- |
| `src/components/landing/cta.tsx` | primitives 직접 import로 전환. |
| `src/components/landing/pipeline.tsx` | primitives 직접 import로 전환. |
| `src/components/landing/features.tsx` | primitives 직접 import로 전환. |
| `src/components/landing/hero.tsx` | primitives 직접 import로 전환. |
| `src/components/landing/for-who.tsx` | primitives 직접 import로 전환. |
| `src/components/landing/build-in-public.tsx` | primitives 직접 import로 전환. |
| `src/components/landing/footer.tsx` | primitives 직접 import로 전환. |
| `src/components/landing/hero-cta.tsx` | 히어로 CTA 애니메이션에 reduced motion 적용. |
| `src/components/mobile/slider-notch.tsx` | 슬라이더 노치 애니메이션에 reduced motion 적용. |
| `src/components/landing/primitives.tsx` | 사용하지 않는 배럴 export 제거. |
| `src/components/landing/primitives/section.tsx` | 사용하지 않는 Section primitive 제거. |
| `src/components/notes-list/pane-wrapper.tsx` | 훅과 호환되도록 nullable ref 허용. |
| `src/components/pane/pane-wrapper.tsx` | 훅과 호환되도록 nullable ref 허용. |

### 기술적 결정

1. **Direct Import 적용**: 랜딩 primitives 배럴을 제거하고 명시적 import로 전환.
2. **Reduced Motion 준수**: Hero CTA와 slider notch 애니메이션이 reduced motion을 따르도록 수정.
3. **Ref 타입 보정**: `useRef`가 반환하는 nullable ref에 맞게 타입 수정.

### 검증

- TypeScript: 통과 (`bun run build`)
- 빌드: 통과 (`bun run build`)
- 테스트: 미실행

### 참고

`@coscientist/web` 정적 생성 단계에서 `--localstorage-file` 경로 관련 경고가 발생했지만 빌드는 성공했습니다.

---

## Node LTS 고정 및 빌드 경고 제거

**범위**: `apps/web`, repo root

### 변경 사항

| 파일 | 변경 사항 |
| ---- | --------- |
| `.prototools` | Node.js 24.13.0을 LTS로 고정. |
| `package.json` | Node 엔진 범위를 `>=24 <25`로 제한. |
| `apps/web/package.json` | 래퍼 제거 후 `build` 스크립트를 `next build`로 복원. |
| `apps/web/scripts/next-build.js` | 빌드 래퍼 제거. |

### 기술적 결정

1. **Node 24 LTS 사용**: Node 25에서 Next.js 정적 생성 시 `--localstorage-file` 경고가 발생하므로 LTS로 고정.
2. **Proto Pinning**: `.prototools`로 nvm/volta 없이도 로컬 툴체인 일관성 유지.

### 검증

- TypeScript: 통과 (`proto exec --tools-from-config -- bun run build`)
- 빌드: 통과 (`proto exec --tools-from-config -- bun run build`)
- 테스트: 미실행
