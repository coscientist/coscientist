---
title: "2026-01-18"
description: "apps/web Clerk 인증 및 대기자 명단 통합"
---

## Clerk 인증 통합 및 구현 패턴

**범위**: `apps/web`

### 1단계: 초기 통합

| 파일 | 변경 사항 |
| ---- | --------- |
| `package.json` | `@clerk/nextjs@^6.36.8` 추가 |
| `src/proxy.ts` | 기존 `next-intl` i18n 미들웨어와 `clerkMiddleware()` 통합 |
| `src/app/[locale]/layout.tsx` | 앱을 감싸는 `<ClerkProvider>` 래퍼 추가 |
| `src/components/layout/app-header.tsx` | `SignedIn`/`SignedOut` 조건부 렌더링으로 `SignInButton`, `SignUpButton`, `UserButton` 추가 |
| `.env.local.example` | Clerk API 키 플레이스홀더 생성 |

### 2단계: 종합 구현 및 패턴

| 파일 | 변경 사항 |
| ---- | --------- |
| `src/env.ts` | Zod 스키마로 Clerk 환경 변수 유효성 검사 추가 |
| `src/proxy.ts` | `createRouteMatcher`와 `auth.protect()`를 사용한 라우트 보호 미들웨어 강화 |
| `src/app/[locale]/profile/page.tsx` | `auth()`와 `currentUser()`를 활용한 서버 사이드 인증 보호 페이지 생성 |
| `src/app/api/user/route.ts` | 인증 가드가 적용된 보호 API 라우트 예시 생성 |
| `src/components/user-greeting.tsx` | `useUser()` 훅을 사용하는 클라이언트 컴포넌트 예시 생성 |

### 기술적 결정

1. **미들웨어 체이닝**: `clerkMiddleware()`를 외부 래퍼로 사용하고 기존 i18n 로직을 내부 핸들러로 전달. 인증을 추가하면서 로케일 쿠키 동작을 유지.

2. **Provider 배치**: `ClerkProvider`가 `RootLayoutWrapper`를 감싸서 헤더를 포함한 앱 전체에서 인증 컨텍스트 사용 가능.

3. **모달 인증 플로우**: `SignInButton`과 `SignUpButton`에 `mode="modal"` 사용으로 인증 중에도 현재 페이지 유지.

4. **환경 변수 유효성 검사**: `env.ts`의 기존 Zod 스키마를 확장하여 Clerk 대시보드를 안내하는 설명적 오류 메시지와 함께 Clerk 키 포함.

5. **미들웨어 라우트 보호**: `createRouteMatcher()`로 보호 라우트 패턴(`/*/profile(.*)`) 정의, `auth.protect()`로 인증 강제. 로케일 접두사 라우트를 허용하면서 보호 유지.

6. **서버 사이드 인증 패턴**:
   - 최소 인증 데이터(userId 확인)에는 `auth()` 사용
   - 전체 사용자 객체가 필요할 때는 `currentUser()` 사용
   - 미인증 사용자는 홈페이지로 리다이렉트

7. **API 라우트 보호**: REST 규칙에 따라 미인증 API 요청에 401 Unauthorized 반환.

8. **클라이언트 컴포넌트 패턴**: 사용자 데이터 렌더링 전 적절한 로딩 및 로그인 상태 확인과 함께 `useUser()` 훅 사용.

### 구현 패턴

#### 서버 컴포넌트 인증

```typescript
import { auth, currentUser } from "@clerk/nextjs/server";

const { userId } = await auth();
if (!userId) redirect("/");

const user = await currentUser();
```

#### API 라우트 인증

```typescript
import { auth } from "@clerk/nextjs/server";

const { userId } = await auth();
if (!userId) {
  return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
}
```

#### 클라이언트 컴포넌트 인증

```typescript
"use client";
import { useUser } from "@clerk/nextjs";

const { isLoaded, isSignedIn, user } = useUser();
```

#### 미들웨어 라우트 보호

```typescript
import { clerkMiddleware, createRouteMatcher } from "@clerk/nextjs/server";

const isProtectedRoute = createRouteMatcher(["/*/profile(.*)"]);

export default clerkMiddleware(async (auth, request) => {
  if (isProtectedRoute(request)) {
    await auth.protect();
  }
  // ... 기타 미들웨어 로직
});
```

### 검증

- TypeScript: 통과
- LSP 진단: 오류 없음
- 빌드: `.env.local`에 Clerk API 키 필요 (예상된 동작)

---

## Clerk 대기자 명단(Waitlist) 통합

**범위**: `apps/web`

### 변경 사항

| 파일 | 변경 사항 |
| ---- | --------- |
| `src/app/[locale]/layout.tsx` | `<ClerkProvider>`에 `waitlistUrl="/"` prop 추가 |
| `src/components/layout/app-header.tsx` | `SignedIn`/`SignedOut`/`SignInButton`/`SignUpButton`을 `useClerk().openWaitlist()` 모달 트리거로 교체 |
| `src/components/landing/hero-cta.tsx` | 커스텀 폼을 Clerk 네이티브 `<Waitlist />` 컴포넌트로 교체 |
| `messages/*.json` (25개 로케일 전체) | `header.joinWaitlist` 번역 키 추가, 사용하지 않는 커스텀 폼 키 제거 |

### 기술적 결정

1. **네이티브 Clerk `<Waitlist />` 컴포넌트**: 커스텀 대기자 명단 폼을 직접 구현하는 대신 `@clerk/nextjs`의 내장 `<Waitlist />` 컴포넌트 활용. 다음과 같은 이점 제공:
   - 다른 Clerk 컴포넌트와 일관된 스타일링
   - 내장된 이메일 유효성 검사 및 제출 처리
   - Clerk 대시보드와 대기자 명단 관리 통합
   - 커스텀 백엔드 불필요

2. **`openWaitlist()` 모달**: 헤더의 "Join Waitlist" 버튼이 `useClerk().openWaitlist()`를 사용해 Clerk 대기자 명단 모달 열기. 기존 SignIn/SignUp이 모달을 열던 UX 패턴과 일치.

3. **히어로 인라인 배치**: 히어로 섹션에 메인 CTA 아래 `<Waitlist />` 컴포넌트를 인라인으로 표시하여 대기자 명단 가입의 즉각적인 가시성 제공.

4. **커스텀 폼 코드 제거**: useState 기반 커스텀 폼 구현을 Clerk 네이티브 솔루션으로 대체하여 코드 복잡성과 유지보수 부담 감소.

### 구현 패턴

#### 헤더 대기자 명단 버튼

```typescript
"use client"
import { useClerk } from "@clerk/nextjs"

export function AppHeader() {
  const { openWaitlist } = useClerk()
  
  return (
    <Button onClick={() => openWaitlist()}>
      Join Waitlist
    </Button>
  )
}
```

#### 히어로 인라인 대기자 명단

```typescript
import { Waitlist } from "@clerk/nextjs"

export function HeroCTA() {
  return (
    <div>
      {/* 기본 CTA */}
      <span>or</span>
      <Waitlist />
    </div>
  )
}
```

### 검증

- TypeScript: 통과
- LSP 진단: 오류 0개
- 빌드: 통과 (3760 페이지 생성)

### 사전 요구사항

Clerk 대시보드에서 대기자 명단 모드를 활성화해야 합니다:
1. **User & Authentication** → **Restrictions** (또는 **Waitlist settings**)로 이동
2. **Waitlist** 모드 활성화
3. 필요에 따라 자동 승인 또는 수동 검토 설정

### 다음 단계

사용자는 `.env.local`에 실제 Clerk API 키를 추가해야 합니다:

```bash
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...
CLERK_SECRET_KEY=sk_test_...
```
