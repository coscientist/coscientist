---
title: "ADR 7: Presence와 커서 (실시간 사용자 인식)"
---

## 배경

협업 애플리케이션에서 **사용자 presence 인식**을 제공하는 것이 중요하다: 누가 온라인인지, 같은 콘텐츠를 보거나 편집하는지, 커서나 선택이 어디에 있는지 확인.

<Callout type="info" title="Presence가 중요한 이유">
  - 충돌 방지에 도움 (다른 사람이 입력하는 곳을 편집하지 않기) - 협업과 사회적
  연결감 추가 - 정적 위키를 활기찬 작업 공간으로 전환
</Callout>

보통 기능에는: 현재 보거나 편집하는 사용자 목록/아바타, 누군가 입력 중인지 표시기, 텍스트에서 각 사용자 위치를 보여주는 라이브 커서나 하이라이트가 포함된다.

Convex는 실시간 기능이 있지만 presence 데이터는 다른 특성을 가진다: **임시적** (모든 커서 이동을 유지할 필요 없음)이고 **고빈도** (커서 이동은 초당 여러 번일 수 있음).

## 결정 사항

<Callout type="info" title="핵심 접근법">
  **주기적 하트비트와 경량 커서 데이터로 문서당 각 사용자 활동을 추적하는 Convex
  기반 presence 시스템을 구현하고 최소 지연으로 정보를 표시한다.**
</Callout>

### Presence 테이블

`(documentId, userId)`로 키가 지정된 항목으로 Convex 테이블 `presence` 생성:

| 필드         | 타입   | 목적                                                 |
| ------------ | ------ | ---------------------------------------------------- |
| `userId`     | string | 사용자 식별자 (또는 세션 ID)                         |
| `documentId` | string | 보거나 편집 중인 문서                                |
| `lastActive` | number | 마지막 하트비트나 액션의 타임스탬프                  |
| `cursorPos`  | object | 현재 커서/선택 표현                                  |
| `status`     | string | "editing" / "online" / "idle" 또는 `isTyping` 플래그 |

### 핵심 메커니즘

<Tabs items={["참여/퇴장", "하트비트", "반응형 쿼리", "커서 처리"]}>
  <Tab value="참여/퇴장">
    **참여:** 사용자가 문서를 열면 presence 항목을 추가하거나 업데이트.
    **퇴장:** 다른 곳으로 이동하거나 연결 해제되면 시간 초과 후 제거하거나
    오프라인으로 표시.
  </Tab>
  <Tab value="하트비트">
    각 클라이언트가 몇 초마다 (예: 5초마다) 하트비트(Convex mutation)를 보내서
    `lastActive` 업데이트. **최적화:** 사용자가 활발하게 편집 중이면 (step 전송)
    본질적으로 presence를 업데이트하므로 활동 중에 별도 하트비트 건너뛸 수 있음.
  </Tab>
  <Tab value="반응형 쿼리">
    Convex 쿼리 함수가 문서의 모든 presence 레코드를 반환하고 임계값 넘어
    오프라인인 것 필터링. Convex 쿼리가 **반응형**이므로 모든 구독 클라이언트가
    presence 레코드 변경 시마다 업데이트 받음.
  </Tab>
  <Tab value="커서 처리">
    **MVP 접근법:** 정확한 문자 위치보다 사용자가 집중하는 Block이나 섹션 추적.
    정밀한 텍스트 커서에는 ProseMirror 위치 매핑이 필요 (복잡함). MVP는 약간의
    부정확성을 수용하거나 편집 후 커서를 느리게 업데이트할 수 있음. **대안:**
    ProseMirror의 협업 편집 인식을 사용해서 무언가 선택할 때 사용자
    하이라이트(색상 선택) 표시.
  </Tab>
</Tabs>

### 프론트엔드 표시

- **Facepile:** 문서에 사용자 아바타, 온라인/오프라인별로 그룹화하고 안정적 순서(참여 시간별 정렬)
- **색상 커서:** 각 사용자가 할당된 색상 받음 (userId 해시)
- **입력 표시기:** 활발하게 텍스트 입력 시 상태를 "typing"으로 업데이트

### 성능 최적화

<Callout type="warn" title="속도 제한">
범람을 피하려고 **presence 업데이트를 속도 제한**. 커서 위치를 최대 초당 5번 또는 유휴 중지 시 업데이트.

**Single-flight** 패턴 사용: 사용자가 커서를 빠르게 이동하면 업데이트를 일괄 처리하거나 최신 것만 전송. 하나가 이미 진행 중이면 중간 업데이트 삭제.

</Callout>

## 왜 이렇게 결정했나

- **사회적 presence가 UX 개선:** 실시간으로 협력자를 보면 연결감이 생기고 서로를 맹목적으로 덮어쓸 수 있다는 느낌 방지

- **Convex가 presence에 적합:** Convex의 실시간 푸시와 자동 무효화로 별도 WebSocket 채널 설정 없이 presence 구현 가능

- **확립된 패턴:** Convex 자체 예제 유틸리티의 영향 – 부분 업데이트를 저장하고 사용자당 상태를 병합할 것을 제안

- **커서 인덱싱 과제 인식:** 텍스트 커서 위치를 정확하게 공유하는 건 복잡. 실용적인 부분 구현(Block 수준 또는 대략적 인덱스) 선택

- **임시 vs 영구 트레이드오프:** Presence 데이터는 반임시적; "지금"과 단기 히스토리에 관심. Convex에 저장해서 `lastActive`에 대한 내구성을 얻어 누군가 마지막 온라인 시점 표시에 유용

## 검토한 대안들

<Tabs items={["Presence 없음", "폴링", "외부 Pub-Sub", "전체 CRDT"]}>
  <Tab value="Presence 없음">
    **Presence 표시기 없음:** 핵심 편집에 집중하려고 나중으로 연기. **기각** –
    현대적 기대와 온라인 사용자 표시의 최소한의 노력을 고려해 MVP에 포함.
  </Tab>
  <Tab value="폴링">
    **실시간 대신 폴링:** 클라이언트가 몇 초마다 다른 사람의 presence를 폴링.
    **기각** – 덜 효율적이고 실시간 아님. Convex 푸시가 폴링을 불필요하게 만듦.
  </Tab>
  <Tab value="외부 Pub-Sub">
    **Pusher나 Ably 사용:** 고빈도 업데이트용 외부 pub-sub 서비스. **기각** –
    Convex가 기본 사항을 다루니 필요 없음. 다른 서비스 추가는 과함.
  </Tab>
  <Tab value="전체 CRDT">
    **커서용 전체 CRDT:** CRDT 목록의 항목으로 각 커서. **기각** – 이 작은
    기능에 너무 복잡.
  </Tab>
</Tabs>

## 영향

- **개인 정보:** 일부 경우 presence가 개인 정보 문제를 제기할 수 있음. 지금은 모든 presence가 문서 접근 권한 있는 사람에게 표시. 나중에 "스텔스 모드" 추가 가능.

- **UI 과부하:** 많은 사용자가 있으면 수십 개 커서 표시가 압도적일 수 있음. 처음 5개 커서를 표시하고 "+n명 더" 표시기로 제한.

- **편집기 상태와의 일관성:** 사용자 연결이 나쁘면 하트비트가 떨어질 수 있음. 깜박임을 피하려고 유예 기간 선택 (예: 마지막 하트비트 후 10초).

- **색상과 신원:** 각 사용자가 문서 세션당 일관된 색상을 받도록 보장. userId를 색상으로 해시하거나 메모리 내 맵 유지.

- **데이터 정리:** 사용자가 명시적으로 로그아웃하지 않고 문서를 닫으면 하트비트 메커니즘이 결국 하트비트가 멈추고 `lastActive`가 오래되면 오프라인으로 표시.

## 확장 경로

<Cards>
  <Card
    title="정밀한 협업 커서"
    href="/docs/adr/adr-003-collaboration-protocol"
  >
    문서 변경을 통해 텍스트 커서 추적을 위한 강력한 솔루션 구현. 특정 버전에
    매핑된 커서 위치를 브로드캐스트하는 ProseMirror 플러그인 사용.
  </Card>
  <Card
    title="선택 & 주석"
    href="/docs/adr/adr-004-edge-types-dialectical-graph"
  >
    단일 커서에서 전체 텍스트 선택(범위)으로 확장. 누군가 텍스트 덩어리를 강조
    표시했는지 표시.
  </Card>
  <Card
    title="여러 Presence 범위"
    href="/docs/adr/adr-008-platform-boundaries-expansion"
  >
    다른 범위로 presence 일반화: 프로젝트 수준, 플랫폼 전체(온라인 사용자 목록).
  </Card>
  <Card
    title="활동 표시"
    href="/docs/adr/adr-008-platform-boundaries-expansion"
  >
    상세 활동을 표시하도록 presence 확장: "Alice가 Title Block 편집 중" 또는
    "Bob이 댓글 작성 중".
  </Card>
</Cards>

<Callout type="idea" title="AI 에이전트 Presence">
  AI 에이전트가 참여하면 (예: 제안하는 AI "공동 과학자") presence에 반영할 수
  있음 ("AI Bot이 온라인 상태"). 에이전트 프로세스가 사용자처럼 presence를
  업데이트하도록 구현.
</Callout>
