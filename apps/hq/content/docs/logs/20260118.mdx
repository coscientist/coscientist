---
title: "2026-01-18"
description: "Clerk authentication & waitlist integration for apps/web"
---

## Clerk Authentication Integration & Implementation

**Scope**: `apps/web`

### Phase 1: Initial Integration

| File                                   | Change                                                                                               |
| -------------------------------------- | ---------------------------------------------------------------------------------------------------- |
| `package.json`                         | Added `@clerk/nextjs@^6.36.8`                                                                        |
| `src/proxy.ts`                         | Integrated `clerkMiddleware()` with existing `next-intl` i18n middleware                             |
| `src/app/[locale]/layout.tsx`          | Added `<ClerkProvider>` wrapper around app                                                           |
| `src/components/layout/app-header.tsx` | Added `SignInButton`, `SignUpButton`, `UserButton` with `SignedIn`/`SignedOut` conditional rendering |
| `.env.local.example`                   | Created with placeholder Clerk API keys                                                              |

### Phase 2: Comprehensive Implementation & Patterns

| File                                | Change                                                                                          |
| ----------------------------------- | ----------------------------------------------------------------------------------------------- |
| `src/env.ts`                        | Added Clerk environment variable validation with Zod schema                                     |
| `src/proxy.ts`                      | Enhanced middleware with route protection using `createRouteMatcher` and `auth.protect()`       |
| `src/app/[locale]/profile/page.tsx` | Created protected profile page demonstrating server-side auth with `auth()` and `currentUser()` |
| `src/app/api/user/route.ts`         | Created protected API route example with auth guard                                             |
| `src/components/user-greeting.tsx`  | Created client component example using `useUser()` hook                                         |

### Technical Decisions

1. **Middleware Chaining**: Used `clerkMiddleware()` as the outer wrapper, passing the existing i18n logic as the inner handler. This preserves locale cookie behavior while adding auth.

2. **Provider Placement**: `ClerkProvider` wraps `RootLayoutWrapper` to ensure auth context is available throughout the app, including the header.

3. **Modal Auth Flow**: Used `mode="modal"` for `SignInButton` and `SignUpButton` to keep users on the current page during auth.

4. **Environment Variable Validation**: Extended existing Zod schema in `env.ts` to include Clerk keys with descriptive error messages pointing to the Clerk dashboard.

5. **Middleware Route Protection**: Used `createRouteMatcher()` to define protected routes pattern (`/*/profile(.*)`) and `auth.protect()` to enforce authentication. This pattern allows locale-prefixed routes while maintaining protection.

6. **Server-Side Auth Pattern**:
   - Use `auth()` for minimal auth data (userId check)
   - Use `currentUser()` for full user object when needed
   - Redirect unauthenticated users to home page

7. **API Route Protection**: Return 401 Unauthorized for unauthenticated API requests, following REST conventions.

8. **Client Component Pattern**: Use `useUser()` hook with proper loading and signed-in state checks before rendering user data.

### Implementation Patterns

#### Server Component Auth

```typescript
import { auth, currentUser } from "@clerk/nextjs/server";

const { userId } = await auth();
if (!userId) redirect("/");

const user = await currentUser();
```

#### API Route Auth

```typescript
import { auth } from "@clerk/nextjs/server";

const { userId } = await auth();
if (!userId) {
  return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
}
```

#### Client Component Auth

```typescript
"use client";
import { useUser } from "@clerk/nextjs";

const { isLoaded, isSignedIn, user } = useUser();
```

#### Middleware Route Protection

```typescript
import { clerkMiddleware, createRouteMatcher } from "@clerk/nextjs/server";

const isProtectedRoute = createRouteMatcher(["/*/profile(.*)"]);

export default clerkMiddleware(async (auth, request) => {
  if (isProtectedRoute(request)) {
    await auth.protect();
  }
  // ... other middleware logic
});
```

### Files Created

1. **Protected Page**: `/app/[locale]/profile/page.tsx` - Demonstrates server-side auth
2. **Protected API**: `/app/api/user/route.ts` - Demonstrates API route protection
3. **Client Component**: `/components/user-greeting.tsx` - Demonstrates client-side hooks

### Verification

- TypeScript: Pass (all files)
- LSP Diagnostics: No errors
- Build: Requires Clerk API keys in `.env.local` (expected behavior)

### Research Findings

**Key Clerk Patterns for Next.js 15 App Router**:

- Server Components: `auth()` for auth state, `currentUser()` for user data
- Client Components: `useUser()`, `useAuth()` hooks
- Route Protection: `auth.protect()` in middleware or pages
- Conditional Rendering: `<SignedIn>`, `<SignedOut>`, `<Protect>` components

**Best Practices**:

- Avoid passing full `currentUser()` object to frontend (contains `privateMetadata`)
- Use `auth.protect()` for route-level protection
- Use `createRouteMatcher()` for pattern-based route matching
- Validate environment variables at build time with Zod

### Next Steps

User must add real Clerk API keys to `.env.local`:

```bash
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...
CLERK_SECRET_KEY=sk_test_...
```

---

## Clerk Waitlist Integration

**Scope**: `apps/web`

### Changes Made

| File | Change |
| ---- | ------ |
| `src/app/[locale]/layout.tsx` | Added `waitlistUrl="/"` prop to `<ClerkProvider>` |
| `src/components/layout/app-header.tsx` | Replaced `SignedIn`/`SignedOut`/`SignInButton`/`SignUpButton` with `useClerk().openWaitlist()` modal trigger |
| `src/components/landing/hero-cta.tsx` | Replaced custom form with Clerk's native `<Waitlist />` component |
| `messages/*.json` (all 25 locales) | Added `header.joinWaitlist` translation key, removed unused custom form keys |

### Technical Decisions

1. **Native Clerk `<Waitlist />` Component**: Instead of building a custom waitlist form, leveraged Clerk's built-in `<Waitlist />` component from `@clerk/nextjs`. This provides:
   - Consistent styling with other Clerk components
   - Built-in email validation and submission handling
   - Integration with Clerk Dashboard for waitlist management
   - No custom backend needed

2. **Modal via `openWaitlist()`**: The header "Join Waitlist" button uses `useClerk().openWaitlist()` to open Clerk's waitlist modal, matching the previous UX pattern where SignIn/SignUp opened modals.

3. **Inline Hero Placement**: The hero section shows `<Waitlist />` component inline below the main CTAs, providing immediate visibility for waitlist signup.

4. **Removed Custom Form Code**: Deleted the custom useState-based form implementation in favor of Clerk's native solution, reducing code complexity and maintenance burden.

### Implementation Pattern

#### Header Waitlist Button

```typescript
"use client"
import { useClerk } from "@clerk/nextjs"

export function AppHeader() {
  const { openWaitlist } = useClerk()
  
  return (
    <Button onClick={() => openWaitlist()}>
      Join Waitlist
    </Button>
  )
}
```

#### Hero Inline Waitlist

```typescript
import { Waitlist } from "@clerk/nextjs"

export function HeroCTA() {
  return (
    <div>
      {/* Primary CTAs */}
      <span>or</span>
      <Waitlist />
    </div>
  )
}
```

### Verification

- TypeScript: Pass
- LSP Diagnostics: 0 errors
- Build: Pass (3760 pages generated)

### Prerequisites

User must enable Waitlist mode in Clerk Dashboard:
1. Go to **User & Authentication** â†’ **Restrictions** (or **Waitlist settings**)
2. Enable **Waitlist** mode
3. Configure auto-approve or manual review as needed

---

## Pane Animation & Registration Refactor

**Scope**: `apps/web`

### Changes Made

| File | Change |
| ---- | ------ |
| `src/lib/animations.ts` | Centralized pane variants, added `closeButtonVariants`, introduced `reducedMotionTransition`. |
| `src/components/pane/pane-wrapper.tsx` | Switched to shared variants import and tightened transition/ref typing. |
| `src/components/pane/pane-content-wrapper.tsx` | Pulled pane content/close button variants from `lib/animations`. |
| `src/components/pane/pane-collapsed-spine.tsx` | Reused shared spine variants from `lib/animations`. |
| `src/components/pane/use-pane-registration.ts` | Added a shared hook to register pane refs with the collapse context. |
| `src/components/pane/note-pane.tsx` | Adopted the shared registration hook and reduced-motion transition constant. |
| `src/components/notes-list/all-notes-list.tsx` | Adopted the shared registration hook and reduced-motion transition constant. |
| `src/components/notes-list/pane-wrapper.tsx` | Typed motion transitions/ref props with `Transition`/`RefObject`. |
| `src/components/mobile/coverflow-pane.tsx` | Simplified reduced-motion transition handling. |
| `src/lib/landing-animations.ts` | Reused the shared reduced-motion transition constant. |
| `src/components/landing/hero-title.tsx` | Reused the shared reduced-motion transition constant. |
| `src/components/client/pane-orchestrator.tsx` | Switched to direct AllNotesList import to avoid barrel indirection. |
| `src/components/all-notes-list.tsx` | Removed the barrel re-export file. |
| `src/components/pane/pane-animations.ts` | Removed duplicate animation definitions (now in `lib/animations`). |

### Technical Decisions

1. **Single Animation Source**: Merged pane animation variants into `lib/animations` to avoid drift and duplication.
2. **Reduced Motion Consistency**: Introduced a shared `reducedMotionTransition` constant to keep behavior consistent and avoid inline objects.
3. **Shared Pane Ref Registration**: Added `usePaneRegistration` to standardize pane ref lifecycle management across panes.
4. **Stronger Motion Typing**: Switched pane wrapper transition/ref props to `Transition`/`RefObject` for better type safety.
5. **Direct Imports**: Dropped the AllNotesList barrel to keep imports explicit and reduce bundle indirection.

### Verification

- TypeScript: Not run
- Build: Not run
- Tests: Not run

### Next Steps

Run TypeScript/build checks if you want validation on the refactor.

---

## Landing Imports & Reduced Motion Fixes

**Scope**: `apps/web`

### Changes Made

| File | Change |
| ---- | ------ |
| `src/components/landing/cta.tsx` | Switched to direct primitive imports. |
| `src/components/landing/pipeline.tsx` | Switched to direct primitive imports. |
| `src/components/landing/features.tsx` | Switched to direct primitive imports. |
| `src/components/landing/hero.tsx` | Switched to direct primitive imports. |
| `src/components/landing/for-who.tsx` | Switched to direct primitive imports. |
| `src/components/landing/build-in-public.tsx` | Switched to direct primitive imports. |
| `src/components/landing/footer.tsx` | Switched to direct primitive imports. |
| `src/components/landing/hero-cta.tsx` | Added reduced motion handling for hero CTA animation. |
| `src/components/mobile/slider-notch.tsx` | Added reduced motion handling for slider notch animations. |
| `src/components/landing/primitives.tsx` | Removed unused barrel export file. |
| `src/components/landing/primitives/section.tsx` | Removed unused Section primitive. |
| `src/components/notes-list/pane-wrapper.tsx` | Allowed nullable pane refs for hook compatibility. |
| `src/components/pane/pane-wrapper.tsx` | Allowed nullable pane refs for hook compatibility. |

### Technical Decisions

1. **Direct Imports Over Barrels**: Removed the landing primitives barrel to keep imports explicit and minimize bundle indirection.
2. **Reduced Motion Compliance**: Ensured hero CTA and slider notch animations respect reduced motion preferences.
3. **Ref Type Safety**: Updated pane wrapper ref types to accept nullable refs from `useRef`.

### Verification

- TypeScript: Pass (via `bun run build`)
- Build: Pass (via `bun run build`)
- Tests: Not run

### Notes

Build logs show non-blocking warnings about `--localstorage-file` without a valid path during `@coscientist/web` static generation.

---

## Node LTS Pin & Build Warning Removal

**Scope**: `apps/web`, repo root

### Changes Made

| File | Change |
| ---- | ------ |
| `.prototools` | Pinned Node.js to 24.13.0 for consistent LTS usage. |
| `package.json` | Restricted Node engine to `>=24 <25` to avoid Node 25 warnings. |
| `apps/web/package.json` | Restored `build` script to `next build` after removing wrapper. |
| `apps/web/scripts/next-build.js` | Removed build wrapper (no longer needed). |

### Technical Decisions

1. **Use Node 24 LTS**: Node 25 emits `--localstorage-file` warnings during Next.js static generation; pinning Node 24 resolves the issue.
2. **Proto Pinning**: `.prototools` keeps the local toolchain consistent without requiring nvm/volta.

### Verification

- TypeScript: Pass (via `proto exec --tools-from-config -- bun run build`)
- Build: Pass (via `proto exec --tools-from-config -- bun run build`)
- Tests: Not run
